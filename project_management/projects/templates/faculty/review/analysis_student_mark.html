{% extends 'faculty/base.html' %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    .back-button {
        margin-bottom: 20px;
    }
    .view-analytics, 
    .view-analytics img {
        cursor: pointer;
        z-index: 1;
        position: relative;
    }
    .view-analytics.btn:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }
    .table td {
        vertical-align: middle;
    }
    /* Style for image button */
    .view-analytics-img {
        border: none;
        background: none;
        padding: 0;
        margin: 0;
        cursor: pointer;
    }
    .view-analytics-img:hover {
        opacity: 0.8;
    }
    .view-analytics-img img {
        max-width: 100px;
        height: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Student List Table Section -->
    <div id="studentTableSection">
        <h2 class="text-center mb-4">Student Marks Analysis</h2>
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th style="width: 40%">Student Name</th>
                        <th style="width: 30%">Register Number</th>
                        <th style="width: 30%">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students|dictsort:"register_number" %}
                    <tr>
                        <td class="text-nowrap text-truncate" style="max-width: 200px;" title="{{ student.student_name }}">
                            {{ student.student_name }}
                        </td>
                        <td class="text-center">{{ student.register_number }}</td>
                        <td class="text-center">
                            <button type="button" class="view-analytics-img" data-register="{{ student.register_number }}">
                                <img src="/static/images/view_analytics.png" alt="View Analytics">
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Analytics Section (Initially Hidden) -->
    <div id="analyticsSection" style="display: none;">
        <button type="button" class="btn btn-secondary back-button">
            <i class="fas fa-arrow-left"></i> Back to Student List
        </button>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title text-center">Student Analytics</h5>
                <div id="studentInfo" class="text-center mb-4">
                    <h5 class="student-name">Loading...</h5>
                    <p class="student-details small"></p>
                </div>
                <div id="analyticsContent">
                    <!-- Content will be added here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded'); // Debug log

    // Function to show student table
    function showStudentTable() {
        document.getElementById('studentTableSection').style.display = 'block';
        document.getElementById('analyticsSection').style.display = 'none';
    }

    // Function to show analytics section
    function showAnalyticsSection() {
        document.getElementById('studentTableSection').style.display = 'none';
        document.getElementById('analyticsSection').style.display = 'block';
    }

    // Function to handle analytics button click
    function handleAnalyticsClick(event) {
        console.log('Button clicked'); // Debug log
        event.preventDefault();
        event.stopPropagation();
        
        // Get the button element (works for both button and image)
        const button = event.currentTarget;
        const registerNumber = button.getAttribute('data-register');
        
        if (!registerNumber) {
            console.error('No register number found');
            return;
        }

        console.log('Register number:', registerNumber); // Debug log

        // Show loading state
        document.querySelector('.student-name').textContent = 'Loading...';
        document.querySelector('.student-details').textContent = '';
        
        // Show analytics section
        showAnalyticsSection();
    }

    // Add click event listeners to all analytics buttons (both types)
    const analyticsButtons = document.querySelectorAll('.view-analytics-img, .view-analytics');
    console.log('Found buttons:', analyticsButtons.length); // Debug log

    analyticsButtons.forEach(button => {
        button.addEventListener('click', handleAnalyticsClick);
        console.log('Added click listener to button'); // Debug log
    });

    // Also add click listeners to the images inside buttons
    document.querySelectorAll('.view-analytics-img img').forEach(img => {
        img.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            const button = this.closest('.view-analytics-img');
            if (button) {
                button.click();
            }
        });
    });

    // Add click listener for back button
    const backButton = document.querySelector('.back-button');
    if (backButton) {
        backButton.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            showStudentTable();
        });
    }
});
</script>
{% endblock %}