{% extends 'faculty/base.html' %}
{% load static %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .chart-container {
        width: 100%;
        height: 300px;
        margin: 0 auto;
    }
    .page-content {
    margin-left: 26rem;
    transition: all 0.4s;
    padding: 20px;
    min-height: 100vh;
}

    .criteria-chart-container {
        width: 100%;
        height: 250px;
        margin: 0 auto;
    }
    .analysis-buttons-container {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 10px;
    }
    .analysis-button {
        min-width: 200px;
        margin: 5px;
    }
    .department-filter-card {
        margin-bottom: 2rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .analysis-options-card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .content-section {
        margin-top: 2rem;
    }
    .review-container {
        margin-bottom: 3rem;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .criteria-section {
        margin-bottom: 2rem;
    }
    .criteria-title {
        margin-bottom: 1rem;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 0.25rem;
    }
    .outcome-analysis {
        margin-top: 2rem;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
    }
    .outcome-chart {
        max-width: 400px;
        margin: 0 auto;
    }
    .outcome-stats {
        margin-top: 1rem;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
    }
    @media (max-width: 768px) {
        .chart-container {
            height: 250px;
        }
    }

    /* New wrapper to shift content right */
    .content-wrapper {
        margin-left: 23px; /* Adjust this value as needed */
    }
</style>
{% endblock %}




{% block content %}
<input type="hidden" id="departmentValue" value="{{ department }}">

<div class="container-fluid">
    <!-- Department Filter -->
     {% if role == 'principal' %}
    <div class="row">
        <div class="col-12">
            <div class="card department-filter-card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Department Filter</h4>
        </div>
        <div class="card-body">
            <form method="GET" class="row align-items-end">
                <div class="col-md-4">
                    <div class="form-group mb-0">
                        <label for="department" class="font-weight-bold">Select Department:</label>
                        <select name="department" id="department" class="form-control" onchange="this.form.submit()">
                            <option value="">All Departments</option>
                            {% for dept in available_departments %}
                                <option value="{{ dept }}" {% if dept == selected_department %}selected{% endif %}>
                                    {{ dept }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Apply Filter</button>
                </div>
            </form>
        </div>
    </div>
        </div>
    </div>
    {% endif %}
        
    <!-- Review Analysis Options -->
    <div class="row">
        <div class="col-12">
            <div class="card analysis-options-card">
            <div class="card-header bg-light">
                <h4 class="mb-0">Review Analysis Options</h4>
            </div>
            <div class="card-body">
                    <div class="analysis-buttons-container">
                        <button type="button" class="btn btn-primary analysis-button" onclick="showContent('review1')">
                                    Review 1 Analysis
                                </button>
                        <button type="button" class="btn btn-success analysis-button" onclick="showContent('review2')">
                                    Review 2 Analysis
                                </button>
                        <button type="button" class="btn btn-info analysis-button" onclick="showContent('review3')">
                                    Review 3 Analysis
                                </button>
                        <button type="button" class="btn analysis-button" 
                                style="background: linear-gradient(to right, #f00567, #0ee44e); border: none; color: white;" 
                                onclick="showContent('allReviews')">
                                    All Reviews Analysis
                                </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Publication/Conference Analysis -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title text-center mb-4" style="font-size: 2rem; font-weight: bold;">Publication/Conference Analysis</h3>
                    <div class="row">
                        <div class="col-md-2-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title text-center" style="font-size: 1.2rem;">National Conference</h5>
                                    <canvas id="nationalChart"></canvas>
                                    <div class="text-center mt-3">
                                        <h6 style="font-size: 1.1rem;">Achieved: {{ national_achieved }} / {{ national_total }}</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title text-center" style="font-size: 1.2rem;">International Conference</h5>
                                    <canvas id="internationalChart"></canvas>
                                    <div class="text-center mt-3">
                                        <h6 style="font-size: 1.1rem;">Achieved: {{ international_achieved }} / {{ international_total }}</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title text-center" style="font-size: 1.2rem;">SCI Journal</h5>
                                    <canvas id="sciChart"></canvas>
                                    <div class="text-center mt-3">
                                        <h6 style="font-size: 1.1rem;">Achieved: {{ sci_achieved }} / {{ sci_total }}</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title text-center" style="font-size: 1.2rem;">SCIE Journal</h5>
                                    <canvas id="scieChart"></canvas>
                                    <div class="text-center mt-3">
                                        <h6 style="font-size: 1.1rem;">Achieved: {{ scie_achieved }} / {{ scie_total }}</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title text-center" style="font-size: 1.2rem;">UGC Journal</h5>
                                    <canvas id="ugcChart"></canvas>
                                    <div class="text-center mt-3">
                                        <h6 style="font-size: 1.1rem;">Achieved: {{ ugc_achieved }} / {{ ugc_total }}</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Outcome Analysis -->
    <div class="content-sections">
        <!-- Review 1 Container -->
        <div id="review1Content" class="content-section mb-4" style="display: none;">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Review 1 Analysis</h3>
                </div>
                <div class="card-body">
                <div class="criteria-analysis">
                    <h4 class="mb-3" style="font-size: 1.5rem;">Criteria-wise Analysis</h4>
                    <div id="review1CriteriaCharts"></div>
                </div>

                <div class="outcome-analysis">
                    <h4 class="mb-3">Project Outcome Analysis</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="outcome-chart">
                                <canvas id="review1OutcomeChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="review1OutcomeStats" class="outcome-stats"></div>
                        </div>
                    </div>
                </div>

                <div class="marks-table mt-4">
                    <h4 class="mb-3">Detailed Marks Analysis</h4>
                    <div id="review1MarksTable"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review 2 Container -->
        <div id="review2Content" class="content-section mb-4" style="display: none;">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">Review 2 Analysis</h3>
                </div>
                <div class="card-body">
                <div class="criteria-analysis">
                    <h4 class="mb-3" style="font-size: 1.5rem;">Criteria-wise Analysis</h4>
                    <div id="review2CriteriaCharts"></div>
                </div>

                <div class="outcome-analysis">
                    <h4 class="mb-3">Project Outcome Analysis</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="outcome-chart">
                                <canvas id="review2OutcomeChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="review2OutcomeStats" class="outcome-stats"></div>
                        </div>
                    </div>
                </div>

                <div class="marks-table mt-4">
                    <h4 class="mb-3">Detailed Marks Analysis</h4>
                    <div id="review2MarksTable"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review 3 Container -->
        <div id="review3Content" class="content-section mb-4" style="display: none;">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">Review 3 Analysis</h3>
                </div>
                <div class="card-body">
                <div class="criteria-analysis">
                    <h4 class="mb-3" style="font-size: 1.5rem;">Criteria-wise Analysis</h4>
                    <div id="review3CriteriaCharts"></div>
                </div>

                <div class="outcome-analysis">
                    <h4 class="mb-3">Project Outcome Analysis</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="outcome-chart">
                                <canvas id="review3OutcomeChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="review3OutcomeStats" class="outcome-stats"></div>
                        </div>
                    </div>
                </div>

                <div class="marks-table mt-4">
                    <h4 class="mb-3">Detailed Marks Analysis</h4>
                    <div id="review3MarksTable"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Reviews Container -->
        <div id="allReviewsContent" class="content-section mb-4" style="display: none;">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h3 class="mb-0">All Reviews Combined Analysis</h3>
                </div>
                <div class="card-body">
                    <div class="criteria-analysis">
                        <h4 class="mb-3" style="font-size: 1.5rem;">Criteria-wise Analysis (All Reviews)</h4>
                        <div id="allReviewsCriteriaCharts"></div>
                    </div>

                    <div class="outcome-analysis">
                        <h4 class="mb-3">Project Outcome Analysis</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="outcome-chart">
                                    <canvas id="allReviewsOutcomeChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="allReviewsOutcomeStats" class="outcome-stats"></div>
                            </div>
                        </div>
                    </div>

                    <div class="marks-table mt-4">
                        <h4 class="mb-3">Detailed Marks Analysis</h4>
                        <div id="allReviewsMarksTable"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>



<style>
    @media (min-width: 768px) {
        .col-md-2-4 {
            flex: 0 0 20%;
            max-width: 20%;
        }
    }
    @media (max-width: 767px) {
        .col-md-2-4 {
            flex: 0 0 50%;
            max-width: 50%;
            margin-bottom: 20px;
        }
    }
    .card {
        height: 100%;
    }
    .card-body {
        padding: 1rem;
    }
    .card-title {
        font-size: 1.2rem !important;
        margin-bottom: 1rem;
        font-weight: bold;
    }
    canvas {
        max-height: 150px;
    }
    h6 {
        font-size: 1.1rem !important;
        margin-bottom: 0;
        font-weight: 600;
    }
</style>

<script>
async function fetchReviewData(reviewNumber) {
    try {
        const department = document.getElementById('departmentValue').value;
        console.log('Fetching data for review:', reviewNumber, 'department:', department);
        
        // Fetch criteria data
        const criteriaResponse = await fetch(`/get-criteria/${reviewNumber}/`);
        if (!criteriaResponse.ok) {
            throw new Error(`Failed to fetch criteria data: ${criteriaResponse.statusText}`);
        }
        const criteriaData = await criteriaResponse.json();
        console.log('Criteria data:', criteriaData);
        
        // Fetch marks data from projects_review_marks_master
        const marksResponse = await fetch(`/get-review-marks-master/${reviewNumber}/?department=${encodeURIComponent(department)}`);
        if (!marksResponse.ok) {
            throw new Error(`Failed to fetch marks data: ${marksResponse.statusText}`);
        }
        const marksData = await marksResponse.json();
        console.log('Marks data:', marksData);
        
        if (!marksData || marksData.length === 0) {
            console.warn('No marks data found for review:', reviewNumber);
            // Display a message to the user
            const container = document.getElementById(`review${reviewNumber}Content`);
            if (container) {
                container.querySelector('.card-body').innerHTML = `
                    <div class="alert alert-info">
                        No data found for this review. Please check if marks have been entered.
                    </div>
                `;
            }
            return;
        }

        // Process the marks data
        const processedMarksData = marksData.map(record => {
            // Convert marks to numbers and handle null/undefined values
            const processMarks = (marks) => {
                if (!marks) return {};
                const processed = {};
                Object.entries(marks).forEach(([key, value]) => {
                    processed[key] = value !== null && value !== undefined ? parseFloat(value) : 0;
                });
                return processed;
            };

            return {
                register_number: record.register_number,
                guide_marks: processMarks(record.guide_marks),
                reviewer1_marks: processMarks(record.reviewer1_marks),
                reviewer2_marks: processMarks(record.reviewer2_marks),
                reviewer3_marks: processMarks(record.reviewer3_marks)
            };
        });

        console.log('Processed marks data:', processedMarksData);
        
        // Process and display the data
        updateCriteriaCharts(reviewNumber, processedMarksData, criteriaData);
        updateOutcomeAnalysis(reviewNumber, processedMarksData);
        updateDetailedTable(reviewNumber, processedMarksData, criteriaData);

    } catch (error) {
        console.error('Error in fetchReviewData:', error);
        alert('Error fetching data: ' + error.message);
    }
}

function updateCriteriaCharts(reviewNumber, marksData, criteriaData) {
    try {
        console.log('Updating criteria charts for review:', reviewNumber);
        console.log('Marks data:', marksData);
        console.log('Criteria data:', criteriaData);

        const container = document.getElementById(`review${reviewNumber}CriteriaCharts`);
        if (!container) {
            console.error(`Container not found for review ${reviewNumber}`);
            return;
        }

        // Clear existing content
        container.innerHTML = '';

        if (!marksData || marksData.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    No marks data available for this review.
                </div>
            `;
            return;
        }

        if (!criteriaData || criteriaData.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    No criteria data available for this review.
                </div>
            `;
            return;
        }

        // Define gradient colors based on review number
        const gradientColors = {
            '1': {
                start: '#007bff', // Review 1 primary blue
                end: '#dc3545'    // Red
            },
            '2': {
                start: '#28a745', // Review 2 success green
                end: '#dc3545'    // Red
            },
            '3': {
                start: '#17a2b8', // Review 3 info blue
                end: '#dc3545'    // Red
            },
            'allReviews': {
                start: '#6c757d', // All Reviews gray
                end: '#dc3545'    // Red
            }
        };

        // Create two rows for the charts
        const row1 = document.createElement('div');
        row1.className = 'row mb-4';
        const row2 = document.createElement('div');
        row2.className = 'row';

        // Process marks for each criteria
        criteriaData.forEach((criteria, index) => {
            const criteriaKey = `criteria_${index + 1}`;
            console.log('Processing criteria:', criteriaKey);
            
            // Calculate marks for each evaluator
            const evaluatorMarks = {
                guide: { total: 0, count: 0 },
                reviewer1: { total: 0, count: 0 },
                reviewer2: { total: 0, count: 0 },
                reviewer3: { total: 0, count: 0 }
            };

            // Process marks for each student
            marksData.forEach(record => {
                // Process guide marks
                if (record.guide_marks && record.guide_marks[criteriaKey]) {
                    const mark = parseFloat(record.guide_marks[criteriaKey] || 0);
                    evaluatorMarks.guide.total += mark;
                    evaluatorMarks.guide.count++;
                }

                // Process reviewer marks
                ['reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach((reviewer, idx) => {
                    if (record[reviewer] && record[reviewer][criteriaKey]) {
                        const mark = parseFloat(record[reviewer][criteriaKey] || 0);
                        evaluatorMarks[`reviewer${idx + 1}`].total += mark;
                        evaluatorMarks[`reviewer${idx + 1}`].count++;
                    }
                });
            });

            // Create chart column
            const col = document.createElement('div');
            col.className = 'col-md-2-4';
            col.style.cssText = `
                flex: 0 0 20%;
                max-width: 20%;
                padding: 0 10px;
            `;

            // Create chart wrapper
            const chartWrapper = document.createElement('div');
            chartWrapper.className = 'chart-wrapper text-center';
            
            // Add criteria name
            const criteriaName = document.createElement('div');
            criteriaName.className = 'criteria-name mb-2';
            criteriaName.style.cssText = `
                font-weight: bold;
                color: #343a40;
                font-size: 1rem;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                padding: 5px;
                background: #f8f9fa;
                border-radius: 4px;
                margin-bottom: 10px;
            `;
            criteriaName.textContent = criteria.review_criteria || `Criteria ${index + 1}`;
            chartWrapper.appendChild(criteriaName);

            // Create chart container
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.style.height = '180px';
            
            const canvas = document.createElement('canvas');
            canvas.id = `review${reviewNumber}Criteria${index + 1}Chart`;
            chartContainer.appendChild(canvas);
            chartWrapper.appendChild(chartContainer);

            // Calculate percentages for each evaluator
            const evaluatorPercentages = {
                guide: evaluatorMarks.guide.count > 0 ? 
                    ((evaluatorMarks.guide.total / evaluatorMarks.guide.count) * 10).toFixed(1) : 0,
                reviewer1: evaluatorMarks.reviewer1.count > 0 ? 
                    ((evaluatorMarks.reviewer1.total / evaluatorMarks.reviewer1.count) * 10).toFixed(1) : 0,
                reviewer2: evaluatorMarks.reviewer2.count > 0 ? 
                    ((evaluatorMarks.reviewer2.total / evaluatorMarks.reviewer2.count) * 10).toFixed(1) : 0,
                reviewer3: evaluatorMarks.reviewer3.count > 0 ? 
                    ((evaluatorMarks.reviewer3.total / evaluatorMarks.reviewer3.count) * 10).toFixed(1) : 0
            };

            // Add evaluator percentages
            const percentagesContainer = document.createElement('div');
            percentagesContainer.className = 'evaluator-percentages mt-2';
            percentagesContainer.style.cssText = `
                font-size: 0.9rem;
                color: #666;
                padding: 5px;
                background: #f8f9fa;
                border-radius: 4px;
            `;
            percentagesContainer.innerHTML = `
                <div><small>Guide: ${evaluatorPercentages.guide}%</small></div>
                <div><small>R1: ${evaluatorPercentages.reviewer1}%</small></div>
                <div><small>R2: ${evaluatorPercentages.reviewer2}%</small></div>
                <div><small>R3: ${evaluatorPercentages.reviewer3}%</small></div>
            `;
            chartWrapper.appendChild(percentagesContainer);

            col.appendChild(chartWrapper);

            // Calculate overall percentage
            const totalScore = Object.values(evaluatorPercentages).reduce((sum, val) => sum + parseFloat(val), 0);
            const totalCount = Object.values(evaluatorPercentages).filter(val => parseFloat(val) > 0).length;
            const percentage = totalCount > 0 ? (totalScore / totalCount).toFixed(1) : 0;

            // Create gradient
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, gradientColors[reviewNumber].start);
            gradient.addColorStop(1, gradientColors[reviewNumber].end);

            // Create chart
            new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: ['Score', 'Remaining'],
                    datasets: [{
                        data: [percentage, 100 - percentage],
                        backgroundColor: [gradient, '#f0f0f0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataIndex === 0 ? 
                                        `Overall: ${percentage}%` : 
                                        `Remaining: ${(100 - percentage).toFixed(1)}%`;
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'centerText',
                    afterDraw: function(chart) {
                        const width = chart.width;
                        const height = chart.height;
                        const ctx = chart.ctx;
                        ctx.restore();
                        
                        const fontSize = (height / 80).toFixed(2);
                        ctx.font = `bold ${fontSize}em Arial`;
                        ctx.textBaseline = "middle";
                        ctx.textAlign = "center";
                        
                        const text = percentage + "%";
                        const textY = height / 2;
                        
                        ctx.fillStyle = '#343a40';
                        ctx.fillText(text, width / 2, textY);
                        
                        ctx.font = `${fontSize * 0.4}em Arial`;
                        ctx.fillStyle = '#666';
                        const countText = `${totalCount} evals`;
                        ctx.fillText(countText, width / 2, textY + (fontSize * 15));
                        
                        ctx.save();
                    }
                }]
            });

            // Add to appropriate row
            if (index < 5) {
                row1.appendChild(col);
            } else {
                row2.appendChild(col);
            }
        });

        container.appendChild(row1);
        container.appendChild(row2);
    } catch (error) {
        console.error('Error in updateCriteriaCharts:', error);
        const container = document.getElementById(`review${reviewNumber}CriteriaCharts`);
        if (container) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    Error updating charts: ${error.message}
                </div>
            `;
        }
    }
}

function updateOutcomeAnalysis(reviewNumber, marksData) {
    try {
        const container = document.getElementById(`review${reviewNumber}Content`);
        if (!container) {
            console.error(`Container not found for review ${reviewNumber}`);
            return;
        }

        // Create or get outcome analysis section
        let outcomeSection = container.querySelector('.outcome-analysis');
        if (!outcomeSection) {
            outcomeSection = document.createElement('div');
            outcomeSection.className = 'outcome-analysis';
            outcomeSection.innerHTML = `
                <h4 class="mb-3">Project Outcome Analysis</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="outcome-chart">
                            <canvas id="review${reviewNumber}OutcomeChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="review${reviewNumber}OutcomeStats" class="outcome-stats"></div>
                    </div>
                </div>
            `;
            container.querySelector('.card-body').appendChild(outcomeSection);
        }

        const canvas = document.getElementById(`review${reviewNumber}OutcomeChart`);
        if (!canvas) {
            console.error(`Canvas element with id review${reviewNumber}OutcomeChart not found`);
            return;
        }

        // Ensure canvas has proper dimensions
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error(`Could not get 2D context for canvas review${reviewNumber}OutcomeChart`);
            return;
        }

        // Destroy existing chart if it exists
        const existingChart = Chart.getChart(canvas);
        if (existingChart) {
            existingChart.destroy();
        }

        const outcomeStats = {
            achieved: 0,
            notAchieved: 0,
            total: marksData.length
        };

        // Calculate outcome statistics
        marksData.forEach(record => {
            const scores = [];
            
            if (record.guide_marks) {
                scores.push(Object.values(record.guide_marks).reduce((sum, val) => sum + parseFloat(val || 0), 0) / 10);
            }
            
            ['reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach(reviewer => {
                if (record[reviewer]) {
                    scores.push(Object.values(record[reviewer]).reduce((sum, val) => sum + parseFloat(val || 0), 0) / 10);
                }
            });

            const avgScore = scores.length > 0 ? scores.reduce((sum, score) => sum + score, 0) / scores.length : 0;
            if (avgScore >= 5) {
                outcomeStats.achieved++;
            } else {
                outcomeStats.notAchieved++;
            }
        });

        // Create new chart
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Achieved', 'Not Achieved'],
                datasets: [{
                    data: [outcomeStats.achieved, outcomeStats.notAchieved],
                    backgroundColor: ['#4CAF50', '#f44336']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Project Outcome Achievement'
                    }
                }
            }
        });

        // Update outcome stats
        const statsContainer = document.getElementById(`review${reviewNumber}OutcomeStats`);
        if (statsContainer) {
            statsContainer.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Outcome Statistics</h5>
                        <p>Total Students: ${outcomeStats.total}</p>
                        <p>Achieved: ${outcomeStats.achieved} (${((outcomeStats.achieved / outcomeStats.total) * 100).toFixed(1)}%)</p>
                        <p>Not Achieved: ${outcomeStats.notAchieved} (${((outcomeStats.notAchieved / outcomeStats.total) * 100).toFixed(1)}%)</p>
                    </div>
                </div>
            `;
        }

    } catch (error) {
        console.error('Error in updateOutcomeAnalysis:', error);
    }
}

function updateDetailedTable(reviewNumber, marksData, criteriaData) {
    const tableContainer = document.getElementById(`review${reviewNumber}MarksTable`);
    const table = document.createElement('table');
    table.className = 'table table-bordered table-striped';

    // Create header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th rowspan="2">Register Number</th>
        <th colspan="${criteriaData.length}">Guide Marks</th>
        <th colspan="${criteriaData.length}">Reviewer 1 Marks</th>
        <th colspan="${criteriaData.length}">Reviewer 2 Marks</th>
        <th colspan="${criteriaData.length}">Reviewer 3 Marks</th>
        <th rowspan="2">Average</th>
        <th rowspan="2">Outcome</th>
    `;
    thead.appendChild(headerRow);

    // Create criteria headers
    const criteriaRow = document.createElement('tr');
    for (let i = 0; i < 4; i++) { // For each evaluator type
        criteriaData.forEach((criteria, index) => {
            criteriaRow.innerHTML += `<th>C${index + 1}</th>`;
        });
    }
    thead.appendChild(criteriaRow);
    table.appendChild(thead);

    // Create body
    const tbody = document.createElement('tbody');
    marksData.forEach(record => {
        const row = document.createElement('tr');
        let cellsHtml = `<td>${record.register_number}</td>`;

        // Add marks for each evaluator
        ['guide_marks', 'reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach(evaluator => {
            const marks = record[evaluator] || {};
            criteriaData.forEach((_, index) => {
                const mark = marks[`criteria_${index + 1}`] || '-';
                cellsHtml += `<td>${mark}</td>`;
            });
        });

        // Calculate average and outcome
        const allMarks = [];
        ['guide_marks', 'reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach(evaluator => {
            if (record[evaluator]) {
                const total = Object.values(record[evaluator]).reduce((sum, val) => sum + parseFloat(val || 0), 0);
                allMarks.push(total / 10);
            }
        });

        const average = allMarks.length > 0 ? 
            (allMarks.reduce((sum, mark) => sum + mark, 0) / allMarks.length).toFixed(2) : '-';
        const outcome = average !== '-' && parseFloat(average) >= 5 ? 'Achieved' : 'Not Achieved';
        const outcomeClass = outcome === 'Achieved' ? 'text-success' : 'text-danger';

        cellsHtml += `
            <td>${average}</td>
            <td class="${outcomeClass}">${outcome}</td>
        `;

        row.innerHTML = cellsHtml;
        tbody.appendChild(row);
    });
    table.appendChild(tbody);

    tableContainer.innerHTML = '';
    tableContainer.appendChild(table);
}

async function fetchAllReviewsData() {
    try {
        const department = document.getElementById('departmentValue').value;
        const reviews = [1, 2, 3];
        const allData = {
            criteria: [],
            marks: []
        };

        // Fetch data for all reviews
        for (const reviewNumber of reviews) {
            const criteriaResponse = await fetch(`/get-criteria/${reviewNumber}/`);
            const marksResponse = await fetch(`/get-review-marks-master/${reviewNumber}/?department=${encodeURIComponent(department)}`);
            
            if (!criteriaResponse.ok || !marksResponse.ok) {
                throw new Error(`Failed to fetch data for Review ${reviewNumber}`);
            }

            const criteriaData = await criteriaResponse.json();
            const marksData = await marksResponse.json();

            allData.criteria.push({
                reviewNumber,
                criteria: criteriaData
            });
            allData.marks.push({
                reviewNumber,
                marks: marksData
            });
        }

        // Process and display combined data
        const combinedAnalysis = processCombinedData(allData);
        updateCombinedCharts(combinedAnalysis, allData.criteria[0].criteria);
        updateCombinedOutcomeAnalysis(allData.marks);
        updateCombinedDetailedTable(allData);

    } catch (error) {
        console.error('Error:', error);
        alert(error.message);
    }
}

function processCombinedData(allData) {
    const combinedAnalysis = {};
    
    // Initialize criteria analysis structure
    allData.criteria[0].criteria.forEach((criteria, index) => {
        combinedAnalysis[`criteria_${index + 1}`] = {
            guide: { total: 0, count: 0 },
            reviewer1: { total: 0, count: 0 },
            reviewer2: { total: 0, count: 0 },
            reviewer3: { total: 0, count: 0 }
        };
    });

    // Process marks from all reviews
    allData.marks.forEach(reviewData => {
        reviewData.marks.forEach(record => {
            // Process guide marks
            if (record.guide_marks) {
                Object.entries(record.guide_marks).forEach(([criteria, mark]) => {
                    const criteriaData = combinedAnalysis[criteria];
                    if (criteriaData) {
                        criteriaData.guide.total += parseFloat(mark || 0);
                        criteriaData.guide.count++;
                    }
                });
            }

            // Process reviewer marks
            ['reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach((reviewer, index) => {
                if (record[reviewer]) {
                    Object.entries(record[reviewer]).forEach(([criteria, mark]) => {
                        const criteriaData = combinedAnalysis[criteria];
                        if (criteriaData) {
                            criteriaData[`reviewer${index + 1}`].total += parseFloat(mark || 0);
                            criteriaData[`reviewer${index + 1}`].count++;
                        }
                    });
                }
            });
        });
    });

    return combinedAnalysis;
}

function updateCombinedCharts(analysis, criteriaData) {
    const container = document.getElementById('allReviewsCriteriaCharts');
    if (!container) {
        console.error('Container not found for all reviews charts');
        return;
    }
    container.innerHTML = '';

    // Create two rows for the charts
    const row1 = document.createElement('div');
    row1.className = 'row mb-4';
    const row2 = document.createElement('div');
    row2.className = 'row';

    // Define gradient colors for all reviews
    const gradientColors = {
        start: '#6c757d', // All Reviews gray
        end: '#dc3545'    // Red
    };

    // Create 10 criteria charts
    for (let index = 0; index < 10; index++) {
        const criteriaKey = `criteria_${index + 1}`;
        const criteriaData = analysis[criteriaKey] || {
            guide: { total: 0, count: 0 },
            reviewer1: { total: 0, count: 0 },
            reviewer2: { total: 0, count: 0 },
            reviewer3: { total: 0, count: 0 }
        };

        const col = document.createElement('div');
        col.className = 'col-md-2-4';
        col.style.cssText = `
            flex: 0 0 20%;
            max-width: 20%;
            padding: 0 10px;
        `;

        const chartWrapper = document.createElement('div');
        chartWrapper.className = 'chart-wrapper text-center';
        
        // Add criteria name
        const criteriaName = document.createElement('div');
        criteriaName.className = 'criteria-name mb-2';
        criteriaName.style.cssText = `
            font-weight: bold;
            color: #343a40;
            font-size: 1rem;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 10px;
        `;
        criteriaName.textContent = `Criteria ${index + 1}`;
        chartWrapper.appendChild(criteriaName);

        // Create chart container
        const chartContainer = document.createElement('div');
        chartContainer.className = 'chart-container';
        chartContainer.style.height = '180px';
        
        const canvas = document.createElement('canvas');
        canvas.id = `allReviewsCriteria${index + 1}Chart`;
        chartContainer.appendChild(canvas);
        chartWrapper.appendChild(chartContainer);

        // Calculate percentages for each evaluator
        const evaluatorPercentages = {
            guide: criteriaData.guide.count > 0 ? 
                ((criteriaData.guide.total / criteriaData.guide.count) * 10).toFixed(1) : 0,
            reviewer1: criteriaData.reviewer1.count > 0 ? 
                ((criteriaData.reviewer1.total / criteriaData.reviewer1.count) * 10).toFixed(1) : 0,
            reviewer2: criteriaData.reviewer2.count > 0 ? 
                ((criteriaData.reviewer2.total / criteriaData.reviewer2.count) * 10).toFixed(1) : 0,
            reviewer3: criteriaData.reviewer3.count > 0 ? 
                ((criteriaData.reviewer3.total / criteriaData.reviewer3.count) * 10).toFixed(1) : 0
        };

        // Add evaluator percentages
        const percentagesContainer = document.createElement('div');
        percentagesContainer.className = 'evaluator-percentages mt-2';
        percentagesContainer.style.cssText = `
            font-size: 0.9rem;
            color: #666;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        `;
        percentagesContainer.innerHTML = `
            <div><small>Guide: ${evaluatorPercentages.guide}%</small></div>
            <div><small>R1: ${evaluatorPercentages.reviewer1}%</small></div>
            <div><small>R2: ${evaluatorPercentages.reviewer2}%</small></div>
            <div><small>R3: ${evaluatorPercentages.reviewer3}%</small></div>
        `;
        chartWrapper.appendChild(percentagesContainer);

        col.appendChild(chartWrapper);

        // Calculate overall percentage
        const totalScore = Object.values(evaluatorPercentages).reduce((sum, val) => sum + parseFloat(val), 0);
        const totalCount = Object.values(evaluatorPercentages).filter(val => parseFloat(val) > 0).length;
        const percentage = totalCount > 0 ? (totalScore / totalCount).toFixed(1) : 0;

        // Create gradient
        const ctx = canvas.getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, gradientColors.start);
        gradient.addColorStop(1, gradientColors.end);

        // Create chart
        new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: ['Score', 'Remaining'],
                datasets: [{
                    data: [percentage, 100 - percentage],
                    backgroundColor: [gradient, '#f0f0f0'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataIndex === 0 ? 
                                    `Overall: ${percentage}%` : 
                                    `Remaining: ${(100 - percentage).toFixed(1)}%`;
                            }
                        }
                    }
                }
            },
            plugins: [{
                id: 'centerText',
                afterDraw: function(chart) {
                    const width = chart.width;
                    const height = chart.height;
                    const ctx = chart.ctx;
                    ctx.restore();
                    
                    const fontSize = (height / 80).toFixed(2);
                    ctx.font = `bold ${fontSize}em Arial`;
                    ctx.textBaseline = "middle";
                    ctx.textAlign = "center";
                    
                    const text = percentage + "%";
                    const textY = height / 2;
                    
                    ctx.fillStyle = '#343a40';
                    ctx.fillText(text, width / 2, textY);
                    
                    ctx.font = `${fontSize * 0.4}em Arial`;
                    ctx.fillStyle = '#666';
                    const countText = `${totalCount} evals`;
                    ctx.fillText(countText, width / 2, textY + (fontSize * 15));
                    
                    ctx.save();
                }
            }]
        });

        // Add to appropriate row
        if (index < 5) {
            row1.appendChild(col);
        } else {
            row2.appendChild(col);
        }
    }

    container.appendChild(row1);
    container.appendChild(row2);
}

function updateCombinedOutcomeAnalysis(marksData) {
    try {
        const container = document.getElementById('allReviewsContent');
        if (!container) {
            console.error('Container not found for all reviews');
            return;
        }

        // Create or get outcome analysis section
        let outcomeSection = container.querySelector('.outcome-analysis');
        if (!outcomeSection) {
            outcomeSection = document.createElement('div');
            outcomeSection.className = 'outcome-analysis';
            outcomeSection.innerHTML = `
                <h4 class="mb-3">Project Outcome Analysis</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="outcome-chart">
                            <canvas id="allReviewsOutcomeChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="allReviewsOutcomeStats" class="outcome-stats"></div>
                    </div>
                </div>
            `;
            container.querySelector('.card-body').appendChild(outcomeSection);
        }

        const canvas = document.getElementById('allReviewsOutcomeChart');
        if (!canvas) {
            console.error('Canvas element with id allReviewsOutcomeChart not found');
            return;
        }

        // Ensure canvas has proper dimensions
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error('Could not get 2D context for canvas allReviewsOutcomeChart');
            return;
        }

        // Destroy existing chart if it exists
        const existingChart = Chart.getChart(canvas);
        if (existingChart) {
            existingChart.destroy();
        }

        const outcomeStats = {
            achieved: 0,
            notAchieved: 0,
            total: marksData.length
        };

        // Calculate outcome statistics
        marksData.forEach(record => {
            const scores = [];
            
            if (record.guide_marks) {
                scores.push(Object.values(record.guide_marks).reduce((sum, val) => sum + parseFloat(val || 0), 0) / 10);
            }
            
            ['reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach(reviewer => {
                if (record[reviewer]) {
                    scores.push(Object.values(record[reviewer]).reduce((sum, val) => sum + parseFloat(val || 0), 0) / 10);
                }
            });

            const avgScore = scores.length > 0 ? scores.reduce((sum, score) => sum + score, 0) / scores.length : 0;
            if (avgScore >= 5) {
                outcomeStats.achieved++;
            } else {
                outcomeStats.notAchieved++;
            }
        });

        // Create new chart
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Achieved', 'Not Achieved'],
                datasets: [{
                    data: [outcomeStats.achieved, outcomeStats.notAchieved],
                    backgroundColor: ['#4CAF50', '#f44336']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Project Outcome Achievement'
                    }
                }
            }
        });

        // Update outcome stats
        const statsContainer = document.getElementById('allReviewsOutcomeStats');
        if (statsContainer) {
            statsContainer.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Outcome Statistics</h5>
                        <p>Total Students: ${outcomeStats.total}</p>
                        <p>Achieved: ${outcomeStats.achieved} (${((outcomeStats.achieved / outcomeStats.total) * 100).toFixed(1)}%)</p>
                        <p>Not Achieved: ${outcomeStats.notAchieved} (${((outcomeStats.notAchieved / outcomeStats.total) * 100).toFixed(1)}%)</p>
                    </div>
                </div>
            `;
        }

    } catch (error) {
        console.error('Error in updateCombinedOutcomeAnalysis:', error);
    }
}

function updateCombinedDetailedTable(allData) {
    try {
        const tableContainer = document.getElementById('allReviewsMarksTable');
        if (!tableContainer) {
            console.error('Table container not found');
            return;
        }

        // Create a wrapper div with both horizontal and vertical scroll
        const scrollWrapper = document.createElement('div');
        scrollWrapper.style.cssText = `
            overflow-x: auto;
            overflow-y: auto;
            max-width: 100%;
            max-height: 600px; /* Set maximum height for vertical scroll */
            margin-bottom: 20px;
        `;
        
        const table = document.createElement('table');
        table.className = 'table table-bordered table-striped';
        table.style.cssText = 'min-width: 1500px;'; // Increased minimum width to accommodate all columns

        // Create header with sticky positioning
        const thead = document.createElement('thead');
        thead.style.position = 'sticky';
        thead.style.top = '0';
        thead.style.backgroundColor = 'white';
        thead.style.zIndex = '1';

        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `
            <th rowspan="2" style="position: sticky; left: 0; background: white; z-index: 2;">Register Number</th>
            <th colspan="${allData.criteria[0].criteria.length}">Guide Marks</th>
            <th colspan="${allData.criteria[0].criteria.length}">Reviewer 1 Marks</th>
            <th colspan="${allData.criteria[0].criteria.length}">Reviewer 2 Marks</th>
            <th colspan="${allData.criteria[0].criteria.length}">Reviewer 3 Marks</th>
            <th rowspan="2">Guide Avg</th>
            <th rowspan="2">R1 Avg</th>
            <th rowspan="2">R2 Avg</th>
            <th rowspan="2">R3 Avg</th>
            <th rowspan="2">Overall Avg</th>
            <th rowspan="2">Outcome</th>
        `;
        thead.appendChild(headerRow);

        // Create criteria headers
        const criteriaRow = document.createElement('tr');
        for (let i = 0; i < 4; i++) { // For each evaluator type
            allData.criteria[0].criteria.forEach((criteria, index) => {
                criteriaRow.innerHTML += `<th>C${index + 1}</th>`;
            });
        }
        thead.appendChild(criteriaRow);
        table.appendChild(thead);

        // Create body
        const tbody = document.createElement('tbody');
        
        // Get unique register numbers across all reviews
        const uniqueRegisterNumbers = new Set();
        allData.marks.forEach(reviewData => {
            if (reviewData && reviewData.marks && Array.isArray(reviewData.marks)) {
                reviewData.marks.forEach(record => {
                    if (record && record.register_number) {
                        uniqueRegisterNumbers.add(record.register_number);
                    }
                });
            }
        });
        
        if (uniqueRegisterNumbers.size === 0) {
            tbody.innerHTML = '<tr><td colspan="11" class="text-center">No student records found</td></tr>';
            table.appendChild(tbody);
            scrollWrapper.appendChild(table);
            tableContainer.innerHTML = '';
            tableContainer.appendChild(scrollWrapper);
            return;
        }
        
        // Process each unique register number
        uniqueRegisterNumbers.forEach(registerNumber => {
            const row = document.createElement('tr');
            let cellsHtml = `<td style="position: sticky; left: 0; background: white; z-index: 1;">${registerNumber}</td>`;
            
            // Initialize evaluator averages
            const evaluatorAverages = {
                guide: { total: 0, count: 0 },
                reviewer1: { total: 0, count: 0 },
                reviewer2: { total: 0, count: 0 },
                reviewer3: { total: 0, count: 0 }
            };
            
            // Find all records for this register number across all reviews
            const studentRecords = [];
            allData.marks.forEach(reviewData => {
                if (reviewData && reviewData.marks && Array.isArray(reviewData.marks)) {
                    const found = reviewData.marks.find(record => record && record.register_number === registerNumber);
                    if (found) {
                        studentRecords.push(found);
                    }
                }
            });
            
            // Combine marks from all reviews
            const combinedMarks = {
                guide_marks: {},
                reviewer1_marks: {},
                reviewer2_marks: {},
                reviewer3_marks: {}
            };
            
            studentRecords.forEach(record => {
                ['guide_marks', 'reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach(evaluator => {
                    if (record[evaluator]) {
                        Object.assign(combinedMarks[evaluator], record[evaluator]);
                    }
                });
            });
            
            // Add marks for each evaluator
            ['guide_marks', 'reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach((evaluator, index) => {
                const marks = combinedMarks[evaluator] || {};
                let evaluatorTotal = 0;
                let hasMarks = false;
                
                allData.criteria[0].criteria.forEach((criteria, criteriaIndex) => {
                    const mark = marks[`criteria_${criteriaIndex + 1}`] || '-';
                    cellsHtml += `<td>${mark}</td>`;
                    
                    if (mark !== '-') {
                        evaluatorTotal += parseFloat(mark);
                        hasMarks = true;
                    }
                });
                
                // Calculate average for this evaluator
                if (hasMarks) {
                    const criteriaCount = allData.criteria[0].criteria.length;
                    const average = evaluatorTotal / criteriaCount;
                    const evaluatorKey = index === 0 ? 'guide' : `reviewer${index}`;
                    evaluatorAverages[evaluatorKey].total = average;
                    evaluatorAverages[evaluatorKey].count = 1;
                }
            });
            
            // Add individual averages
            ['guide', 'reviewer1', 'reviewer2', 'reviewer3'].forEach(evaluator => {
                const avg = evaluatorAverages[evaluator].count > 0 ? 
                    evaluatorAverages[evaluator].total.toFixed(2) : '-';
                cellsHtml += `<td>${avg}</td>`;
            });
            
            // Calculate overall average
            const validAverages = Object.values(evaluatorAverages)
                .filter(avg => avg.count > 0)
                .map(avg => avg.total);
            
            const overallAverage = validAverages.length > 0 ? 
                (validAverages.reduce((sum, val) => sum + val, 0) / validAverages.length).toFixed(2) : '-';
            
            cellsHtml += `<td>${overallAverage}</td>`;
            
            // Determine outcome
            const outcome = overallAverage !== '-' && parseFloat(overallAverage) >= 5 ? 'Achieved' : 'Not Achieved';
            const outcomeClass = outcome === 'Achieved' ? 'text-success' : 'text-danger';
            
            cellsHtml += `<td class="${outcomeClass}">${outcome}</td>`;
            
            row.innerHTML = cellsHtml;
            tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
        scrollWrapper.appendChild(table);
        tableContainer.innerHTML = '';
        tableContainer.appendChild(scrollWrapper);
    } catch (error) {
        console.error('Error in updateCombinedDetailedTable:', error);
        const tableContainer = document.getElementById('allReviewsMarksTable');
        if (tableContainer) {
            tableContainer.innerHTML = `<div class="alert alert-danger">Error processing data: ${error.message}</div>`;
        }
    }
}

function showContent(section) {
    // Hide all content sections
    document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
    
    // Show selected section
    const selectedContent = document.getElementById(section + 'Content');
    if (selectedContent) {
        selectedContent.style.display = 'block';
        updateCriteriaAnalysisTitle();
        if (section === 'allReviews') {
            fetchAllReviewsData();
        } else {
            const reviewNumber = section.replace('review', '');
            fetchReviewData(reviewNumber);
        }
    }
}

// Initialize with Review 1
document.addEventListener('DOMContentLoaded', function() {
    // Function to create half-circle chart for publication/conference analysis
    function createHalfCircleChart(canvasId, achieved, total, color) {
        try {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Canvas element with id ${canvasId} not found`);
                return;
            }

            // Ensure canvas has proper dimensions
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error(`Could not get 2D context for canvas ${canvasId}`);
                return;
            }

            const percentage = total > 0 ? (achieved / total) * 100 : 0;
            
            // Destroy existing chart if it exists
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Achieved', 'Remaining'],
                    datasets: [{
                        data: [percentage, 100 - percentage],
                        backgroundColor: [color, '#e9ecef'],
                        borderWidth: 0
                    }]
                },
                options: {
                    circumference: 180,
                    rotation: -90,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        } catch (error) {
            console.error(`Error creating chart for ${canvasId}:`, error);
        }
    }

    // Function to create full circle chart for criteria analysis
    function createFullCircleChart(canvasId, percentage, color) {
        try {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Canvas element with id ${canvasId} not found`);
                return;
            }

            // Ensure canvas has proper dimensions
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error(`Could not get 2D context for canvas ${canvasId}`);
                return;
            }

            // Destroy existing chart if it exists
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Score', 'Remaining'],
                    datasets: [{
                        data: [percentage, 100 - percentage],
                        backgroundColor: [color, '#e9ecef'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        } catch (error) {
            console.error(`Error creating chart for ${canvasId}:`, error);
        }
    }

    // Wait for DOM to be fully loaded and canvas elements to be ready
    setTimeout(() => {
        // Create publication/conference analysis charts with colors matching review buttons
        createHalfCircleChart('nationalChart', {{ national_achieved }}, {{ national_total }}, '#007bff'); // Review 1 color
        createHalfCircleChart('internationalChart', {{ international_achieved }}, {{ international_total }}, '#28a745'); // Review 2 color
        createHalfCircleChart('sciChart', {{ sci_achieved }}, {{ sci_total }}, '#17a2b8'); // Review 3 color
        createHalfCircleChart('scieChart', {{ scie_achieved }}, {{ scie_total }}, '#6c757d'); // All Reviews color
        createHalfCircleChart('ugcChart', {{ ugc_achieved }}, {{ ugc_total }}, '#343a40'); // Dark color for contrast

        // Initialize with Review 1
        showContent('review1');
    }, 100);
});

// Update the section title font size
function updateCriteriaAnalysisTitle() {
    const titles = document.querySelectorAll('.criteria-analysis h4');
    titles.forEach(title => {
        title.style.fontSize = '1.8rem';
        title.style.fontWeight = 'bold';
        title.style.marginBottom = '1.5rem';
    });
}
</script>
{% endblock %}

