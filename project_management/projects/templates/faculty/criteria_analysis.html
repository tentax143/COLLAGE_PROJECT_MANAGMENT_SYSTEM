{% extends 'faculty/base.html' %}
{% load static %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    .chart-container {
        width: 100%;
        height: 300px;
        margin: 0 auto;
    }
    .criteria-chart-container {
        width: 100%;
        height: 250px;
        margin: 0 auto;
    }
    .analysis-buttons-container {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 10px;
    }
    .analysis-button {
        min-width: 200px;
        margin: 5px;
    }
    .department-filter-card {
        margin-bottom: 2rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .analysis-options-card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .content-section {
        margin-top: 2rem;
    }
    .review-container {
        margin-bottom: 3rem;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .criteria-section {
        margin-bottom: 2rem;
    }
    .criteria-title {
        margin-bottom: 1rem;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 0.25rem;
    }
    .outcome-analysis {
        margin-top: 2rem;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
    }
    .outcome-chart {
        max-width: 400px;
        margin: 0 auto;
    }
    .outcome-stats {
        margin-top: 1rem;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
    }
    @media (max-width: 768px) {
        .chart-container {
            height: 250px;
        }
        }
    </style>
{% endblock %}




{% block content %}
<input type="hidden" id="departmentValue" value="{{ department }}">

<div class="container-fluid">
    <!-- Department Filter -->
    <div class="row">
        <div class="col-12">
            <div class="card department-filter-card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Department Filter</h4>
        </div>
        <div class="card-body">
            <form method="GET" class="row align-items-end">
                <div class="col-md-4">
                    <div class="form-group mb-0">
                        <label for="department" class="font-weight-bold">Select Department:</label>
                        <select name="department" id="department" class="form-control" onchange="this.form.submit()">
                            <option value="">All Departments</option>
                            {% for dept in available_departments %}
                                <option value="{{ dept }}" {% if dept == selected_department %}selected{% endif %}>
                                    {{ dept }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Apply Filter</button>
                </div>
            </form>
        </div>
    </div>
        </div>
    </div>
        
    <!-- Review Analysis Options -->
    <div class="row">
        <div class="col-12">
            <div class="card analysis-options-card">
            <div class="card-header bg-light">
                <h4 class="mb-0">Review Analysis Options</h4>
            </div>
            <div class="card-body">
                    <div class="analysis-buttons-container">
                        <button type="button" class="btn btn-primary analysis-button" onclick="showContent('review1')">
                                    Review 1 Analysis
                                </button>
                        <button type="button" class="btn btn-success analysis-button" onclick="showContent('review2')">
                                    Review 2 Analysis
                                </button>
                        <button type="button" class="btn btn-info analysis-button" onclick="showContent('review3')">
                                    Review 3 Analysis
                                </button>
                        <button type="button" class="btn analysis-button" 
                                style="background: linear-gradient(to right, #f00567, #0ee44e); border: none; color: white;" 
                                onclick="showContent('allReviews')">
                                    All Reviews Analysis
                                </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Publication/Conference Analysis -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title text-center mb-4" style="font-size: 2rem; font-weight: bold;">Publication/Conference Analysis</h3>
                    <div class="row">
                        <div class="col-md-2-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title text-center" style="font-size: 1.2rem;">National Conference</h5>
                                    <canvas id="nationalChart"></canvas>
                                    <div class="text-center mt-3">
                                        <h6 style="font-size: 1.1rem;">Achieved: {{ national_achieved }} / {{ national_total }}</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title text-center" style="font-size: 1.2rem;">International Conference</h5>
                                    <canvas id="internationalChart"></canvas>
                                    <div class="text-center mt-3">
                                        <h6 style="font-size: 1.1rem;">Achieved: {{ international_achieved }} / {{ international_total }}</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title text-center" style="font-size: 1.2rem;">SCI Journal</h5>
                                    <canvas id="sciChart"></canvas>
                                    <div class="text-center mt-3">
                                        <h6 style="font-size: 1.1rem;">Achieved: {{ sci_achieved }} / {{ sci_total }}</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title text-center" style="font-size: 1.2rem;">SCIE Journal</h5>
                                    <canvas id="scieChart"></canvas>
                                    <div class="text-center mt-3">
                                        <h6 style="font-size: 1.1rem;">Achieved: {{ scie_achieved }} / {{ scie_total }}</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title text-center" style="font-size: 1.2rem;">UGC Journal</h5>
                                    <canvas id="ugcChart"></canvas>
                                    <div class="text-center mt-3">
                                        <h6 style="font-size: 1.1rem;">Achieved: {{ ugc_achieved }} / {{ ugc_total }}</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Outcome Analysis -->
    <div class="content-sections">
        <!-- Review 1 Container -->
        <div id="review1Content" class="content-section mb-4" style="display: none;">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Review 1 Analysis</h3>
                </div>
                <div class="card-body">
                <div class="criteria-analysis">
                    <h4 class="mb-3">Criteria-wise Analysis</h4>
                    <div id="review1CriteriaCharts"></div>
                </div>

                <!-- <div class="outcome-analysis">
                    <h4 class="mb-3">Project Outcome Analysis</h4>
                    <div class="row">
                             <div class="col-md-6">
                                <div class="outcome-chart">
                                    <canvas id="review1OutcomeChart"></canvas>
                                </div>
                                </div> -->
                            <!-- <div class="col-md-6">
                                <div id="review1OutcomeStats" class="outcome-stats"></div>
                            </div> -->
                    <!-- </div>
                </div> --> 

                <div class="marks-table mt-4">
                    <h4 class="mb-3">Detailed Marks Analysis</h4>
                    <div id="review1MarksTable"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review 2 Container -->
        <div id="review2Content" class="content-section mb-4" style="display: none;">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">Review 2 Analysis</h3>
                </div>
                <div class="card-body">
                <div class="criteria-analysis">
                    <h4 class="mb-3">Criteria-wise Analysis</h4>
                    <div id="review2CriteriaCharts"></div>
                                    </div>

                <!-- <div class="outcome-analysis">
                    <h4 class="mb-3">Project Outcome Analysis</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="outcome-chart">
                                <canvas id="review2OutcomeChart"></canvas>
                                </div>
                            </div>
                        <div class="col-md-6">
                            <div id="review2OutcomeStats" class="outcome-stats"></div>
                        </div>
                                    </div>
                                </div> -->

                <div class="marks-table mt-4">
                    <h4 class="mb-3">Detailed Marks Analysis</h4>
                    <div id="review2MarksTable"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review 3 Container -->
        <div id="review3Content" class="content-section mb-4" style="display: none;">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">Review 3 Analysis</h3>
                </div>
                <div class="card-body">
                <div class="criteria-analysis">
                    <h4 class="mb-3">Criteria-wise Analysis</h4>
                    <div id="review3CriteriaCharts"></div>
                                    </div>

                <!-- <div class="outcome-analysis">
                    <h4 class="mb-3">Project Outcome Analysis</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="outcome-chart">
                                <canvas id="review3OutcomeChart"></canvas>
                                </div>
                            </div>
                        <div class="col-md-6">
                            <div id="review3OutcomeStats" class="outcome-stats"></div>
                        </div>
                                    </div>
                                </div> -->

                <div class="marks-table mt-4">
                    <h4 class="mb-3">Detailed Marks Analysis</h4>
                    <div id="review3MarksTable"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Reviews Container -->
        <div id="allReviewsContent" class="content-section mb-4" style="display: none;">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h3 class="mb-0">All Reviews Combined Analysis</h3>
                </div>
                <div class="card-body">
                    <div class="criteria-analysis">
                        <h4 class="mb-3">Criteria-wise Analysis (All Reviews)</h4>
                        <div id="allReviewsCriteriaCharts"></div>
                </div>

                    <!-- <div class="outcome-analysis">
                        <h4 class="mb-3">Project Outcome Analysis</h4>
                                    <div class="row">
                                        <div class="col-md-6">
                                <div class="outcome-chart">
                                    <canvas id="allReviewsOutcomeChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                <div id="allReviewsOutcomeStats" class="outcome-stats"></div>
                                                        </div>
                                                    </div>
                                                </div> -->

                    <div class="marks-table mt-4">
                        <h4 class="mb-3">Detailed Marks Analysis</h4>
                        <div id="allReviewsMarksTable"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>



<style>
    @media (min-width: 768px) {
        .col-md-2-4 {
            flex: 0 0 20%;
            max-width: 20%;
        }
    }
    @media (max-width: 767px) {
        .col-md-2-4 {
            flex: 0 0 50%;
            max-width: 50%;
            margin-bottom: 20px;
        }
    }
    .card {
        height: 100%;
    }
    .card-body {
        padding: 1rem;
    }
    .card-title {
        font-size: 1.2rem !important;
        margin-bottom: 1rem;
        font-weight: bold;
    }
    canvas {
        max-height: 150px;
    }
    h6 {
        font-size: 1.1rem !important;
        margin-bottom: 0;
        font-weight: 600;
    }
</style>

<script>
async function fetchReviewData(reviewNumber) {
    try {
        const department = document.getElementById('departmentValue').value;
        
        const criteriaResponse = await fetch(`/get-criteria/${reviewNumber}/`);
        if (!criteriaResponse.ok) {
            throw new Error(`Failed to fetch criteria data: ${criteriaResponse.statusText}`);
        }
        const criteriaData = await criteriaResponse.json();
        
        const marksResponse = await fetch(`/get-review-marks-master/${reviewNumber}/?department=${encodeURIComponent(department)}`);
        if (!marksResponse.ok) {
            throw new Error(`Failed to fetch marks data: ${marksResponse.statusText}`);
        }
        const marksData = await marksResponse.json();
        
        // Process criteria-wise data
        const analysis = processCriteriaData(marksData, criteriaData);
        
        // Update UI
        updateCriteriaCharts(reviewNumber, analysis, criteriaData);
        updateOutcomeAnalysis(reviewNumber, marksData);
        updateDetailedTable(reviewNumber, marksData, criteriaData);

    } catch (error) {
        console.error('Error:', error);
        alert(error.message);
    }
}

function processCriteriaData(marksData, criteriaData) {
    const analysis = {};
    
    // Initialize criteria analysis structure
    criteriaData.forEach((criteria, index) => {
        analysis[`criteria_${index + 1}`] = {
            guide: { total: 0, count: 0 },
            reviewer1: { total: 0, count: 0 },
            reviewer2: { total: 0, count: 0 },
            reviewer3: { total: 0, count: 0 }
        };
    });

    // Process marks for each student
    marksData.forEach(record => {
        // Process guide marks
        if (record.guide_marks) {
            Object.entries(record.guide_marks).forEach(([criteria, mark]) => {
                const criteriaData = analysis[criteria];
                if (criteriaData) {
                    criteriaData.guide.total += parseFloat(mark || 0);
                    criteriaData.guide.count++;
                }
            });
        }

        // Process reviewer marks
        ['reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach((reviewer, index) => {
            if (record[reviewer]) {
                Object.entries(record[reviewer]).forEach(([criteria, mark]) => {
                    const criteriaData = analysis[criteria];
                    if (criteriaData) {
                        criteriaData[`reviewer${index + 1}`].total += parseFloat(mark || 0);
                        criteriaData[`reviewer${index + 1}`].count++;
                    }
                });
            }
        });
    });

    return analysis;
}

function getReviewColor(reviewNumber) {
    const colors = {
        1: {
            primary: '#0d6efd',    // Bootstrap primary
            secondary: '#0a58ca'   // Darker shade
        },
        2: {
            primary: '#198754',    // Bootstrap success
            secondary: '#146c43'   // Darker shade
        },
        3: {
            primary: '#0dcaf0',    // Bootstrap info
            secondary: '#0aa2c0'   // Darker shade
        }
    };
    return colors[reviewNumber] || colors[1];
}

function updateCriteriaCharts(reviewNumber, analysis, criteriaData) {
    const container = document.getElementById(`review${reviewNumber}CriteriaCharts`);
    container.innerHTML = '';

    // Get review-specific colors
    const reviewColor = getReviewColor(parseInt(reviewNumber));

    // Create two rows for the charts
    const row1 = document.createElement('div');
    row1.className = 'row mb-4';
    const row2 = document.createElement('div');
    row2.className = 'row';

    // Destroy existing charts if they exist
    criteriaData.forEach((_, index) => {
        const existingChart = Chart.getChart(`review${reviewNumber}Criteria${index + 1}Chart`);
        if (existingChart) {
            existingChart.destroy();
        }
    });

    criteriaData.forEach((criteria, index) => {
        const criteriaKey = `criteria_${index + 1}`;
        const criteriaData = analysis[criteriaKey];

        // Create chart column (5 columns per row)
        const col = document.createElement('div');
        col.className = 'col-md-2-4';
        col.style.cssText = `
            flex: 0 0 20%;
            max-width: 20%;
            padding: 0 10px;
        `;

        // Create chart container with criteria name and guide marks
        const chartWrapper = document.createElement('div');
        chartWrapper.className = 'chart-wrapper text-center';
        
        // Add guide marks percentage at top
        const guideData = criteriaData.guide;
        const guidePercentage = guideData.count > 0 ? 
            ((guideData.total / guideData.count) * 10).toFixed(1) : 0;
        
        const guideMarks = document.createElement('div');
        guideMarks.className = 'guide-marks mb-2';
        guideMarks.style.cssText = `
            font-size: 1.4rem;
            color: #4CAF50;
            font-weight: bold;
            padding: 5px;
            background: #e8f5e9;
            border-radius: 4px;
            margin: 0 auto 10px auto;
            max-width: 150px;
        `;
        guideMarks.textContent = `Guide: ${guidePercentage}%`;
        chartWrapper.appendChild(guideMarks);

        // Add criteria name from the database
        const criteriaName = document.createElement('div');
        criteriaName.className = 'criteria-name mb-2';
        criteriaName.style.cssText = `
            font-weight: bold;
            color: ${reviewColor.primary};
            font-size: 1.3rem;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 10px;
        `;
        criteriaName.textContent = criteria.review_criteria || `Criteria ${index + 1}`;
        chartWrapper.appendChild(criteriaName);

        // Create chart container
        const chartContainer = document.createElement('div');
        chartContainer.className = 'chart-container';
        chartContainer.style.height = '180px';
        
        const canvas = document.createElement('canvas');
        canvas.id = `review${reviewNumber}Criteria${index + 1}Chart`;
        chartContainer.appendChild(canvas);
        chartWrapper.appendChild(chartContainer);

        // Add cumulative percentages container
        const cumulativeContainer = document.createElement('div');
        cumulativeContainer.className = 'cumulative-percentages mt-2';
        cumulativeContainer.style.cssText = `
            font-size: 1.2rem;
            color: #666;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-top: 10px;
        `;

        // Calculate individual percentages
        const reviewer1Percentage = criteriaData.reviewer1.count > 0 ? 
            ((criteriaData.reviewer1.total / criteriaData.reviewer1.count) * 10).toFixed(1) : 0;
        const reviewer2Percentage = criteriaData.reviewer2.count > 0 ? 
            ((criteriaData.reviewer2.total / criteriaData.reviewer2.count) * 10).toFixed(1) : 0;
        const reviewer3Percentage = criteriaData.reviewer3.count > 0 ? 
            ((criteriaData.reviewer3.total / criteriaData.reviewer3.count) * 10).toFixed(1) : 0;

        cumulativeContainer.innerHTML = `
            <div><small style="font-size: 1.1rem;">R1: ${reviewer1Percentage}%</small></div>
            <div><small style="font-size: 1.1rem;">R2: ${reviewer2Percentage}%</small></div>
            <div><small style="font-size: 1.1rem;">R3: ${reviewer3Percentage}%</small></div>
        `;
        chartWrapper.appendChild(cumulativeContainer);

        col.appendChild(chartWrapper);

        // Calculate combined percentage score
        let totalScore = 0;
        let totalCount = 0;

        ['guide', 'reviewer1', 'reviewer2', 'reviewer3'].forEach(evaluator => {
            const data = criteriaData[evaluator];
            if (data.count > 0) {
                totalScore += data.total;
                totalCount += data.count;
            }
        });

        // Convert to percentage (0-100 scale)
        const percentage = totalCount > 0 ? ((totalScore / totalCount) * 10).toFixed(1) : 0;

        // Create gradient for chart
        const ctx = canvas.getContext('2d');
        const chartGradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
        chartGradient.addColorStop(0, reviewColor.primary);
        chartGradient.addColorStop(1, reviewColor.secondary);

        // Create doughnut chart
        new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: ['Score', 'Remaining'],
                datasets: [{
                    data: [percentage, 100 - percentage],
                    backgroundColor: [chartGradient, '#f0f0f0'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataIndex === 0 ? 
                                    `Overall: ${percentage}%` : 
                                    `Remaining: ${(100 - percentage).toFixed(1)}%`;
                            }
                        }
                    }
                }
            },
            plugins: [{
                id: 'centerText',
                afterDraw: function(chart) {
                    const width = chart.width;
                    const height = chart.height;
                    const ctx = chart.ctx;
                    ctx.restore();
                    
                    // Increase main percentage text size
                    const fontSize = (height / 80).toFixed(2);
                    ctx.font = `bold ${fontSize}em Arial`;
                    ctx.textBaseline = "middle";
                    ctx.textAlign = "center";
                    
                    const text = percentage + "%";
                    const textY = height / 2;

                    ctx.fillStyle = reviewColor.primary;
                    ctx.fillText(text, width / 2, textY);

                    // Increase evaluator count text size
                    ctx.font = `${fontSize * 0.4}em Arial`;
                    ctx.fillStyle = '#666';
                    const countText = `${totalCount} evals`;
                    ctx.fillText(countText, width / 2, textY + (fontSize * 15));
                    
                    ctx.save();
                }
            }]
        });

        // Add to appropriate row (first 5 to row1, rest to row2)
        if (index < 5) {
            row1.appendChild(col);
        } else {
            row2.appendChild(col);
        }
    });

    // Add custom CSS for 5-column layout
    const style = document.createElement('style');
    style.textContent = `
        @media (min-width: 768px) {
            .col-md-2-4 {
                flex: 0 0 20%;
                max-width: 20%;
            }
        }
        @media (max-width: 767px) {
            .col-md-2-4 {
                flex: 0 0 50%;
                max-width: 50%;
                margin-bottom: 20px;
            }
        }
    `;
    container.appendChild(style);

    // Add rows to container
    container.appendChild(row1);
    container.appendChild(row2);
}

function updateOutcomeAnalysis(reviewNumber, marksData) {
    // Destroy existing chart if it exists
    const existingChart = Chart.getChart(`review${reviewNumber}OutcomeChart`);
    if (existingChart) {
        existingChart.destroy();
    }

    const outcomeStats = {
        achieved: 0,
        notAchieved: 0,
        total: marksData.length
    };

    // Calculate outcome statistics
    marksData.forEach(record => {
        const scores = [];
        
        if (record.guide_marks) {
            scores.push(Object.values(record.guide_marks).reduce((sum, val) => sum + parseFloat(val || 0), 0) / 10);
        }
        
        ['reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach(reviewer => {
            if (record[reviewer]) {
                scores.push(Object.values(record[reviewer]).reduce((sum, val) => sum + parseFloat(val || 0), 0) / 10);
            }
        });

        const avgScore = scores.length > 0 ? scores.reduce((sum, score) => sum + score, 0) / scores.length : 0;
        if (avgScore >= 5) { // Assuming 5 out of 10 is the passing score
            outcomeStats.achieved++;
        } else {
            outcomeStats.notAchieved++;
        }
    });

    // Update outcome chart
    const canvas = document.getElementById(`review${reviewNumber}OutcomeChart`);
    new Chart(canvas, {
        type: 'pie',
        data: {
            labels: ['Achieved', 'Not Achieved'],
            datasets: [{
                data: [outcomeStats.achieved, outcomeStats.notAchieved],
                backgroundColor: ['#4CAF50', '#f44336']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Project Outcome Achievement'
                }
            }
        }
    });

    // // Update outcome stats
    // const statsContainer = document.getElementById(`review${reviewNumber}OutcomeStats`);
    // statsContainer.innerHTML = `
    //     <div class="card">
    //         <div class="card-body">
    //             <h5 class="card-title">Outcome Statistics</h5>
    //             <p>Total Students: ${outcomeStats.total}</p>
    //             <p>Achieved: ${outcomeStats.achieved} (${((outcomeStats.achieved / outcomeStats.total) * 100).toFixed(1)}%)</p>
    //             <p>Not Achieved: ${outcomeStats.notAchieved} (${((outcomeStats.notAchieved / outcomeStats.total) * 100).toFixed(1)}%)</p>
    //         </div>
    //     </div>
    // `;
}

function updateDetailedTable(reviewNumber, marksData, criteriaData) {
    const tableContainer = document.getElementById(`review${reviewNumber}MarksTable`);
    const table = document.createElement('table');
    table.className = 'table table-bordered table-striped';

    // Create header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th rowspan="2">Register Number</th>
        <th colspan="${criteriaData.length}">Guide Marks</th>
        <th colspan="${criteriaData.length}">Reviewer 1 Marks</th>
        <th colspan="${criteriaData.length}">Reviewer 2 Marks</th>
        <th colspan="${criteriaData.length}">Reviewer 3 Marks</th>
        <th rowspan="2">Average</th>
        <th rowspan="2">Outcome</th>
    `;
    thead.appendChild(headerRow);

    // Create criteria headers
    const criteriaRow = document.createElement('tr');
    for (let i = 0; i < 4; i++) { // For each evaluator type
        criteriaData.forEach((criteria, index) => {
            criteriaRow.innerHTML += `<th>C${index + 1}</th>`;
        });
    }
    thead.appendChild(criteriaRow);
    table.appendChild(thead);

    // Create body
    const tbody = document.createElement('tbody');
    marksData.forEach(record => {
        const row = document.createElement('tr');
        let cellsHtml = `<td>${record.register_number}</td>`;

        // Add marks for each evaluator
        ['guide_marks', 'reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach(evaluator => {
            const marks = record[evaluator] || {};
            criteriaData.forEach((_, index) => {
                const mark = marks[`criteria_${index + 1}`] || '-';
                cellsHtml += `<td>${mark}</td>`;
            });
        });

        // Calculate average and outcome
        const allMarks = [];
        ['guide_marks', 'reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach(evaluator => {
            if (record[evaluator]) {
                const total = Object.values(record[evaluator]).reduce((sum, val) => sum + parseFloat(val || 0), 0);
                allMarks.push(total / 10);
            }
        });

        const average = allMarks.length > 0 ? 
            (allMarks.reduce((sum, mark) => sum + mark, 0) / allMarks.length).toFixed(2) : '-';
        const outcome = average !== '-' && parseFloat(average) >= 5 ? 'Achieved' : 'Not Achieved';
        const outcomeClass = outcome === 'Achieved' ? 'text-success' : 'text-danger';

        cellsHtml += `
            <td>${average}</td>
            <td class="${outcomeClass}">${outcome}</td>
        `;

        row.innerHTML = cellsHtml;
        tbody.appendChild(row);
    });
    table.appendChild(tbody);

    tableContainer.innerHTML = '';
    tableContainer.appendChild(table);
}

async function fetchAllReviewsData() {
    try {
        const department = document.getElementById('departmentValue').value;
        const reviews = [1, 2, 3];
        const allData = {
            criteria: [],
            marks: []
        };

        // Fetch data for all reviews
        for (const reviewNumber of reviews) {
            const criteriaResponse = await fetch(`/get-criteria/${reviewNumber}/`);
            const marksResponse = await fetch(`/get-review-marks-master/${reviewNumber}/?department=${encodeURIComponent(department)}`);
            
            if (!criteriaResponse.ok || !marksResponse.ok) {
                throw new Error(`Failed to fetch data for Review ${reviewNumber}`);
            }

            const criteriaData = await criteriaResponse.json();
            const marksData = await marksResponse.json();

            allData.criteria.push({
                reviewNumber,
                criteria: criteriaData
            });
            allData.marks.push({
                reviewNumber,
                marks: marksData
            });
        }

        // Process and display combined data
        const combinedAnalysis = processCombinedData(allData);
        updateCombinedCharts(combinedAnalysis, allData.criteria[0].criteria);
        updateCombinedOutcomeAnalysis(allData.marks);
        updateCombinedDetailedTable(allData);

    } catch (error) {
        console.error('Error:', error);
        alert(error.message);
    }
}

function processCombinedData(allData) {
    const combinedAnalysis = {};
    
    // Initialize criteria analysis structure
    allData.criteria[0].criteria.forEach((criteria, index) => {
        combinedAnalysis[`criteria_${index + 1}`] = {
            guide: { total: 0, count: 0 },
            reviewer1: { total: 0, count: 0 },
            reviewer2: { total: 0, count: 0 },
            reviewer3: { total: 0, count: 0 }
        };
    });

    // Process marks from all reviews
    allData.marks.forEach(reviewData => {
        reviewData.marks.forEach(record => {
            // Process guide marks
            if (record.guide_marks) {
                Object.entries(record.guide_marks).forEach(([criteria, mark]) => {
                    const criteriaData = combinedAnalysis[criteria];
                    if (criteriaData) {
                        criteriaData.guide.total += parseFloat(mark || 0);
                        criteriaData.guide.count++;
                    }
                });
            }

            // Process reviewer marks
            ['reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach((reviewer, index) => {
                if (record[reviewer]) {
                    Object.entries(record[reviewer]).forEach(([criteria, mark]) => {
                        const criteriaData = combinedAnalysis[criteria];
                        if (criteriaData) {
                            criteriaData[`reviewer${index + 1}`].total += parseFloat(mark || 0);
                            criteriaData[`reviewer${index + 1}`].count++;
                        }
                    });
                }
            });
        });
    });

    return combinedAnalysis;
}

function updateCombinedCharts(analysis, criteriaData) {
    const container = document.getElementById('allReviewsCriteriaCharts');
    container.innerHTML = '';

    // Create two rows for the charts
    const row1 = document.createElement('div');
    row1.className = 'row mb-4';
    const row2 = document.createElement('div');
    row2.className = 'row';

    // Destroy existing charts
    criteriaData.forEach((_, index) => {
        const existingChart = Chart.getChart(`allReviewsCriteria${index + 1}Chart`);
        if (existingChart) {
            existingChart.destroy();
        }
    });

    criteriaData.forEach((criteria, index) => {
        const criteriaKey = `criteria_${index + 1}`;
        const criteriaData = analysis[criteriaKey];

        const col = document.createElement('div');
        col.className = 'col-md-2-4';
        col.style.cssText = `
            flex: 0 0 20%;
            max-width: 20%;
            padding: 0 10px;
        `;

        const chartWrapper = document.createElement('div');
        chartWrapper.className = 'chart-wrapper text-center';
        
        // Add criteria name
        const criteriaName = document.createElement('div');
        criteriaName.className = 'criteria-name mb-2';
        criteriaName.style.cssText = `
            font-weight: bold;
            color: #343a40;
            font-size: 1rem;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 10px;
        `;
        criteriaName.textContent = criteria.review_criteria || `Criteria ${index + 1}`;
        chartWrapper.appendChild(criteriaName);

        // Create chart container
        const chartContainer = document.createElement('div');
        chartContainer.className = 'chart-container';
        chartContainer.style.height = '180px';
        
        const canvas = document.createElement('canvas');
        canvas.id = `allReviewsCriteria${index + 1}Chart`;
        chartContainer.appendChild(canvas);
        chartWrapper.appendChild(chartContainer);

        // Calculate percentages for each evaluator
        const evaluatorPercentages = {
            guide: criteriaData.guide.count > 0 ? 
                ((criteriaData.guide.total / criteriaData.guide.count) * 10).toFixed(1) : 0,
            reviewer1: criteriaData.reviewer1.count > 0 ? 
                ((criteriaData.reviewer1.total / criteriaData.reviewer1.count) * 10).toFixed(1) : 0,
            reviewer2: criteriaData.reviewer2.count > 0 ? 
                ((criteriaData.reviewer2.total / criteriaData.reviewer2.count) * 10).toFixed(1) : 0,
            reviewer3: criteriaData.reviewer3.count > 0 ? 
                ((criteriaData.reviewer3.total / criteriaData.reviewer3.count) * 10).toFixed(1) : 0
        };

        // Add evaluator percentages
        const percentagesContainer = document.createElement('div');
        percentagesContainer.className = 'evaluator-percentages mt-2';
        percentagesContainer.style.cssText = `
            font-size: 0.9rem;
            color: #666;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        `;
        percentagesContainer.innerHTML = `
            <div><small>Guide: ${evaluatorPercentages.guide}%</small></div>
            <div><small>R1: ${evaluatorPercentages.reviewer1}%</small></div>
            <div><small>R2: ${evaluatorPercentages.reviewer2}%</small></div>
            <div><small>R3: ${evaluatorPercentages.reviewer3}%</small></div>
        `;
        chartWrapper.appendChild(percentagesContainer);

        col.appendChild(chartWrapper);

        // Calculate overall percentage
        const totalScore = Object.values(evaluatorPercentages).reduce((sum, val) => sum + parseFloat(val), 0);
        const totalCount = Object.values(evaluatorPercentages).filter(val => parseFloat(val) > 0).length;
        const percentage = totalCount > 0 ? (totalScore / totalCount).toFixed(1) : 0;

        // Create chart
        new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: ['Score', 'Remaining'],
                datasets: [{
                    data: [percentage, 100 - percentage],
                    backgroundColor: ['#343a40', '#f0f0f0'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataIndex === 0 ? 
                                    `Overall: ${percentage}%` : 
                                    `Remaining: ${(100 - percentage).toFixed(1)}%`;
                            }
                        }
                    }
                }
            },
            plugins: [{
                id: 'centerText',
                afterDraw: function(chart) {
                    const width = chart.width;
                    const height = chart.height;
                    const ctx = chart.ctx;
                    ctx.restore();
                    
                    const fontSize = (height / 80).toFixed(2);
                    ctx.font = `bold ${fontSize}em Arial`;
                    ctx.textBaseline = "middle";
                    ctx.textAlign = "center";
                    
                    const text = percentage + "%";
                    const textY = height / 2;
                    
                    ctx.fillStyle = '#343a40';
                    ctx.fillText(text, width / 2, textY);
                    
                    ctx.font = `${fontSize * 0.4}em Arial`;
                    ctx.fillStyle = '#666';
                    const countText = `${totalCount} evals`;
                    ctx.fillText(countText, width / 2, textY + (fontSize * 15));
                    
                    ctx.save();
                }
            }]
        });

        // Add to appropriate row
        if (index < 5) {
            row1.appendChild(col);
        } else {
            row2.appendChild(col);
        }
    });

    container.appendChild(row1);
    container.appendChild(row2);
}

function updateCombinedOutcomeAnalysis(marksData) {
    // Destroy existing chart if it exists
    const existingChart = Chart.getChart('allReviewsOutcomeChart');
    if (existingChart) {
        existingChart.destroy();
    }

    const outcomeStats = {
        achieved: 0,
        notAchieved: 0,
        total: marksData.length
    };

    // Calculate outcome statistics
    marksData.forEach(record => {
        const scores = [];
        
        if (record.guide_marks) {
            scores.push(Object.values(record.guide_marks).reduce((sum, val) => sum + parseFloat(val || 0), 0) / 10);
        }
        
        ['reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach(reviewer => {
            if (record[reviewer]) {
                scores.push(Object.values(record[reviewer]).reduce((sum, val) => sum + parseFloat(val || 0), 0) / 10);
            }
        });

        const avgScore = scores.length > 0 ? scores.reduce((sum, score) => sum + score, 0) / scores.length : 0;
        if (avgScore >= 5) { // Assuming 5 out of 10 is the passing score
            outcomeStats.achieved++;
        } else {
            outcomeStats.notAchieved++;
        }
    });

    // Update outcome chart
    const canvas = document.getElementById('allReviewsOutcomeChart');
    new Chart(canvas, {
                type: 'pie',
                data: {
            labels: ['Achieved', 'Not Achieved'],
                    datasets: [{
                data: [outcomeStats.achieved, outcomeStats.notAchieved],
                backgroundColor: ['#4CAF50', '#f44336']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                title: {
                    display: true,
                    text: 'Project Outcome Achievement'
                        }
                    }
                }
            });

    // Update outcome stats
    const statsContainer = document.getElementById('allReviewsOutcomeStats');
    statsContainer.innerHTML = `
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Outcome Statistics</h5>
                <p>Total Students: ${outcomeStats.total}</p>
                <p>Achieved: ${outcomeStats.achieved} (${((outcomeStats.achieved / outcomeStats.total) * 100).toFixed(1)}%)</p>
                <p>Not Achieved: ${outcomeStats.notAchieved} (${((outcomeStats.notAchieved / outcomeStats.total) * 100).toFixed(1)}%)</p>
            </div>
        </div>
    `;
}

function updateCombinedDetailedTable(allData) {
    const tableContainer = document.getElementById('allReviewsMarksTable');
    const table = document.createElement('table');
    table.className = 'table table-bordered table-striped';

    // Create header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th rowspan="2">Register Number</th>
        <th colspan="${allData.criteria[0].criteria.length}">Guide Marks</th>
        <th colspan="${allData.criteria[0].criteria.length}">Reviewer 1 Marks</th>
        <th colspan="${allData.criteria[0].criteria.length}">Reviewer 2 Marks</th>
        <th colspan="${allData.criteria[0].criteria.length}">Reviewer 3 Marks</th>
        <th rowspan="2">Average</th>
        <th rowspan="2">Outcome</th>
    `;
    thead.appendChild(headerRow);

    // Create criteria headers
    const criteriaRow = document.createElement('tr');
    for (let i = 0; i < 4; i++) { // For each evaluator type
        allData.criteria[i].criteria.forEach((criteria, index) => {
            criteriaRow.innerHTML += `<th>C${index + 1}</th>`;
        });
    }
    thead.appendChild(criteriaRow);
    table.appendChild(thead);

    // Create body
    const tbody = document.createElement('tbody');
    allData.marks.forEach(reviewData => {
        const row = document.createElement('tr');
        let cellsHtml = `<td>${reviewData.marks[0].register_number}</td>`;

        // Add marks for each evaluator
        ['guide_marks', 'reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach(evaluator => {
            const marks = reviewData.marks[0][evaluator] || {};
            allData.criteria[0].criteria.forEach((criteria, index) => {
                const mark = marks[`criteria_${index + 1}`] || '-';
                cellsHtml += `<td>${mark}</td>`;
            });
        });

        // Calculate average and outcome
        const allMarks = [];
        ['guide_marks', 'reviewer1_marks', 'reviewer2_marks', 'reviewer3_marks'].forEach(evaluator => {
            if (reviewData.marks[0][evaluator]) {
                const total = Object.values(reviewData.marks[0][evaluator]).reduce((sum, val) => sum + parseFloat(val || 0), 0);
                allMarks.push(total / 10);
            }
        });

        const average = allMarks.length > 0 ? 
            (allMarks.reduce((sum, mark) => sum + mark, 0) / allMarks.length).toFixed(2) : '-';
        const outcome = average !== '-' && parseFloat(average) >= 5 ? 'Achieved' : 'Not Achieved';
        const outcomeClass = outcome === 'Achieved' ? 'text-success' : 'text-danger';

        cellsHtml += `
            <td>${average}</td>
            <td class="${outcomeClass}">${outcome}</td>
        `;

        row.innerHTML = cellsHtml;
        tbody.appendChild(row);
    });
    table.appendChild(tbody);

    tableContainer.innerHTML = '';
    tableContainer.appendChild(table);
}

function showContent(section) {
    // Hide all content sections
    document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
    
    // Show selected section
    const selectedContent = document.getElementById(section + 'Content');
    if (selectedContent) {
        selectedContent.style.display = 'block';
        updateCriteriaAnalysisTitle();
        if (section === 'allReviews') {
            fetchAllReviewsData();
        } else {
            const reviewNumber = section.replace('review', '');
            fetchReviewData(reviewNumber);
        }
    }
}

// Initialize with Review 1
document.addEventListener('DOMContentLoaded', function() {
    showContent('review1');
});

document.addEventListener('DOMContentLoaded', function() {
    // Function to create half-circle chart
    function createHalfCircleChart(canvasId, achieved, total, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const percentage = total > 0 ? (achieved / total) * 100 : 0;
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Achieved', 'Remaining'],
                datasets: [{
                    data: [percentage, 100 - percentage],
                    backgroundColor: [color, '#e9ecef'],
                    borderWidth: 0
                }]
            },
            options: {
                circumference: 180,
                rotation: -90,
                cutout: '70%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    }
                },
                responsive: true,
                maintainAspectRatio: true
            }
        });
    }

    // Create charts for each outcome type
    createHalfCircleChart('nationalChart', {{ national_achieved }}, {{ national_total }}, '#FF6384');
    createHalfCircleChart('internationalChart', {{ international_achieved }}, {{ international_total }}, '#36A2EB');
    createHalfCircleChart('sciChart', {{ sci_achieved }}, {{ sci_total }}, '#FFCE56');
    createHalfCircleChart('scieChart', {{ scie_achieved }}, {{ scie_total }}, '#4BC0C0');
    createHalfCircleChart('ugcChart', {{ ugc_achieved }}, {{ ugc_total }}, '#9966FF');
});

// Update the section title font size
function updateCriteriaAnalysisTitle() {
    const titles = document.querySelectorAll('.criteria-analysis h4');
    titles.forEach(title => {
        title.style.fontSize = '1.8rem';
        title.style.fontWeight = 'bold';
        title.style.marginBottom = '1.5rem';
    });
}
</script>
{% endblock %}

